image: ocaml/opam2:ubuntu-lts

stages:
  - build
  - test

build:
  # https://docs.gitlab.com/ee/ci/yaml/#cache
  stage: build
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - _opam
  script:
    - sudo apt install m4 cargo -y
    # - opam switch create 4.07.1
    - eval $(opam env)
    - opam install --deps-only -t -y .
    # Install the static library from rustc
    - git clone https://gitlab.com/dannywillems/rustc-bls12-381 /tmp/rustc-bls12-381
    - cd /tmp/rustc-bls12-381
    - cargo build
    - mkdir -p ${OPAM_SWITCH_PREFIX}/lib/librustc-bls12-381
    - cp target/debug/librustc_bls12_381.a ${OPAM_SWITCH_PREFIX}/lib/librustc-bls12-381/librustc_bls12_381.a

test:
  dependencies:
    - build
  stage: test
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - _opam
  script:
    - opam switch 4.07.1
    - eval $(opam env)
    - opam install .
    - dune runtest
