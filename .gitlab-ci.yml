.build-test-lint: &build_definition
  stage: build
  before_script:
    # Always update system package manager + setup OPAM env
    - sudo apt-get update && sudo apt-get upgrade -y
    - eval $(opam env)
    - opam update
  script:
    # Install external dependencies
    - opam depext -i -y conf-rust zarith
    - opam install --deps-only --with-test -y .
    # Install the static library from rustc
    - git clone https://gitlab.com/dannywillems/rustc-bls12-381 /tmp/rustc-bls12-381
    - cd /tmp/rustc-bls12-381
    - cargo build --release
    - mkdir -p ${OPAM_SWITCH_PREFIX}/lib/librustc-bls12-381
    - cp target/release/librustc_bls12_381.a ${OPAM_SWITCH_PREFIX}/lib/librustc-bls12-381/librustc_bls12_381.a
    - opam install .
    # Run test
    - opam install alcotest
    - cd ${CI_PROJECT_DIR}
    - dune runtest
    # Lint
    - opam install ocamlformat
    - ocamlformat --check src/*.ml*
    - ocamlformat --check test/*.ml*
    - ocamlformat --check benchmark/*.ml*
 
stages:
  - build

build-ocaml-4.07:
  <<: *build_definition
  image: ocaml/opam2:4.07

build-ocaml-4.08:
  <<: *build_definition
  image: ocaml/opam2:4.08

build-ocaml-4.09:
  <<: *build_definition
  image: ocaml/opam2:4.09

# build-ocaml-4.10:
#   <<: *build_definition
#   image: ocaml/opam2:4.10
